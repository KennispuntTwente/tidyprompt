<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Enable LLM to draft and execute SQL queries on a database — answer_using_sql • tidyprompt</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Enable LLM to draft and execute SQL queries on a database — answer_using_sql"><meta name="description" content="Enable LLM to draft and execute SQL queries on a database"><meta property="og:description" content="Enable LLM to draft and execute SQL queries on a database"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidyprompt</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/creating_prompt_wraps.html">Creating prompt wraps</a></li>
    <li><a class="dropdown-item" href="../articles/getting_started.html">Getting started</a></li>
    <li><a class="dropdown-item" href="../articles/sentiment_analysis.html">Sentiment analysis in R with a LLM and 'tidyprompt'</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/KennispuntTwente/tidyprompt/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Enable LLM to draft and execute SQL queries on a database</h1>
      <small class="dont-index">Source: <a href="https://github.com/KennispuntTwente/tidyprompt/blob/main/R/answer_using_sql.R" class="external-link"><code>R/answer_using_sql.R</code></a></small>
      <div class="d-none name"><code>answer_using_sql.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Enable LLM to draft and execute SQL queries on a database</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">answer_using_sql</span><span class="op">(</span></span>
<span>  <span class="va">prompt</span>,</span>
<span>  add_text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"You must code in SQL to answer this prompt."</span>,</span>
<span>    <span class="st">" You must provide all SQL code between ```sql and ```."</span>, <span class="st">"\n\n"</span>,</span>
<span>    <span class="st">"Never make assumptions about the possible values in the tables.\n"</span>,</span>
<span>    <span class="st">"Instead, execute SQL queries to retrieve information you need."</span><span class="op">)</span>,</span>
<span>  <span class="va">conn</span>,</span>
<span>  list_tables <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  describe_tables <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  evaluate_code <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  output_as_tool <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  return_mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"full"</span>, <span class="st">"code"</span>, <span class="st">"object"</span>, <span class="st">"formatted_output"</span>, <span class="st">"llm_answer"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-prompt">prompt<a class="anchor" aria-label="anchor" href="#arg-prompt"></a></dt>
<dd><p>A single string or a <code><a href="tidyprompt.html">tidyprompt()</a></code> object</p></dd>


<dt id="arg-add-text">add_text<a class="anchor" aria-label="anchor" href="#arg-add-text"></a></dt>
<dd><p>Single string which will be added to the prompt text,
informing the LLM that they must use SQL to answer the prompt</p></dd>


<dt id="arg-conn">conn<a class="anchor" aria-label="anchor" href="#arg-conn"></a></dt>
<dd><p>A DBIConnection object to the SQL database</p></dd>


<dt id="arg-list-tables">list_tables<a class="anchor" aria-label="anchor" href="#arg-list-tables"></a></dt>
<dd><p>Logical indicating whether to list tables available in the database
in the prompt text</p></dd>


<dt id="arg-describe-tables">describe_tables<a class="anchor" aria-label="anchor" href="#arg-describe-tables"></a></dt>
<dd><p>Logical indicating whether to describe the tables available in the database
in the prompt text. If TRUE, the columns of each table will be listed</p></dd>


<dt id="arg-evaluate-code">evaluate_code<a class="anchor" aria-label="anchor" href="#arg-evaluate-code"></a></dt>
<dd><p>Logical indicating whether to evaluate the SQL code.
If TRUE, the SQL code will be executed on the database and the results will be returned.
Use with caution, as this allows the LLM to execute arbitrary SQL code</p></dd>


<dt id="arg-output-as-tool">output_as_tool<a class="anchor" aria-label="anchor" href="#arg-output-as-tool"></a></dt>
<dd><p>Logical indicating whether to return the output as a tool result.
If TRUE, the output of the SQL query will be sent back to the LLM as a tool result.
The LLM can then provide a final answer or try another query. This can
continue until the LLM provides a final answer without any SQL code</p></dd>


<dt id="arg-return-mode">return_mode<a class="anchor" aria-label="anchor" href="#arg-return-mode"></a></dt>
<dd><p>Character string indicating the return mode. Options are:</p><ul><li><p>"full": Return a list containing the SQL code, output, and formatted output</p></li>
<li><p>"code": Return only the SQL code</p></li>
<li><p>"object": Return only the query result object</p></li>
<li><p>"formatted_output": Return the formatted output: a string detailing the SQL code
and query result object.This is identical to how the LLM would see the output when
output_as_tool is TRUE</p></li>
<li><p>"llm_answer": Return the LLM answer. If output as tool is TRUE,
the return mode will always be "llm_answer" (since the LLM uses SQL to
provide a final answer)</p></li>
</ul></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A <code><a href="tidyprompt.html">tidyprompt()</a></code> with an added <code><a href="prompt_wrap.html">prompt_wrap()</a></code> which will ensure
that the LLM will use SQL to answer the prompt</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>Other pre_built_prompt_wraps:
<code><a href="add_text.html">add_text</a>()</code>,
<code><a href="answer_as_boolean.html">answer_as_boolean</a>()</code>,
<code><a href="answer_as_category.html">answer_as_category</a>()</code>,
<code><a href="answer_as_integer.html">answer_as_integer</a>()</code>,
<code><a href="answer_as_json.html">answer_as_json</a>()</code>,
<code><a href="answer_as_list.html">answer_as_list</a>()</code>,
<code><a href="answer_as_multi_category.html">answer_as_multi_category</a>()</code>,
<code><a href="answer_as_named_list.html">answer_as_named_list</a>()</code>,
<code><a href="answer_as_regex_match.html">answer_as_regex_match</a>()</code>,
<code><a href="answer_as_text.html">answer_as_text</a>()</code>,
<code><a href="answer_by_chain_of_thought.html">answer_by_chain_of_thought</a>()</code>,
<code><a href="answer_by_react.html">answer_by_react</a>()</code>,
<code><a href="answer_using_r.html">answer_using_r</a>()</code>,
<code><a href="answer_using_tools.html">answer_using_tools</a>()</code>,
<code><a href="prompt_wrap.html">prompt_wrap</a>()</code>,
<code><a href="quit_if.html">quit_if</a>()</code>,
<code><a href="set_system_prompt.html">set_system_prompt</a>()</code></p>
<p>Other answer_using_prompt_wraps:
<code><a href="answer_using_r.html">answer_using_r</a>()</code>,
<code><a href="answer_using_tools.html">answer_using_tools</a>()</code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span>  <span class="co"># Create an in-memory SQLite database</span></span></span>
<span class="r-in"><span>  <span class="va">conn</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">SQLite</span><span class="op">(</span><span class="op">)</span>, <span class="st">":memory:"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Create a sample table of customers</span></span></span>
<span class="r-in"><span>  <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">dbExecute</a></span><span class="op">(</span><span class="va">conn</span>, <span class="st">"</span></span></span>
<span class="r-in"><span><span class="st">  CREATE TABLE</span></span></span>
<span class="r-in"><span><span class="st">    customers (</span></span></span>
<span class="r-in"><span><span class="st">      id INTEGER PRIMARY KEY,</span></span></span>
<span class="r-in"><span><span class="st">      name TEXT,</span></span></span>
<span class="r-in"><span><span class="st">      email TEXT,</span></span></span>
<span class="r-in"><span><span class="st">      country TEXT</span></span></span>
<span class="r-in"><span><span class="st">    );</span></span></span>
<span class="r-in"><span><span class="st">  "</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Insert some sample customer data</span></span></span>
<span class="r-in"><span>  <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">dbExecute</a></span><span class="op">(</span><span class="va">conn</span>, <span class="st">"</span></span></span>
<span class="r-in"><span><span class="st">  INSERT INTO</span></span></span>
<span class="r-in"><span><span class="st">    customers (name, email, country)</span></span></span>
<span class="r-in"><span><span class="st">  VALUES</span></span></span>
<span class="r-in"><span><span class="st">    ('Alice', 'alice@example.com', 'USA'),</span></span></span>
<span class="r-in"><span><span class="st">    ('Bob', 'bob@example.com', 'Canada'),</span></span></span>
<span class="r-in"><span><span class="st">    ('Charlie', 'charlie@example.com', 'UK'),</span></span></span>
<span class="r-in"><span><span class="st">    ('Diana', 'diana@example.com', 'USA');</span></span></span>
<span class="r-in"><span><span class="st">  "</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Create another sample table for orders</span></span></span>
<span class="r-in"><span>  <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">dbExecute</a></span><span class="op">(</span><span class="va">conn</span>, <span class="st">"</span></span></span>
<span class="r-in"><span><span class="st">  CREATE TABLE orders (</span></span></span>
<span class="r-in"><span><span class="st">    order_id INTEGER PRIMARY KEY,</span></span></span>
<span class="r-in"><span><span class="st">    customer_id INTEGER,</span></span></span>
<span class="r-in"><span><span class="st">    product TEXT,</span></span></span>
<span class="r-in"><span><span class="st">    amount REAL,</span></span></span>
<span class="r-in"><span><span class="st">    order_date TEXT,</span></span></span>
<span class="r-in"><span><span class="st">    FOREIGN KEY(customer_id) REFERENCES customers(id)</span></span></span>
<span class="r-in"><span><span class="st">  );</span></span></span>
<span class="r-in"><span><span class="st">  "</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Insert some sample orders</span></span></span>
<span class="r-in"><span>  <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">dbExecute</a></span><span class="op">(</span><span class="va">conn</span>, <span class="st">"</span></span></span>
<span class="r-in"><span><span class="st">  INSERT INTO</span></span></span>
<span class="r-in"><span><span class="st">    orders (customer_id, product, amount, order_date)</span></span></span>
<span class="r-in"><span><span class="st">  VALUES</span></span></span>
<span class="r-in"><span><span class="st">    (1, 'Widget', 19.99, '2024-01-15'),</span></span></span>
<span class="r-in"><span><span class="st">    (1, 'Gadget', 29.99, '2024-01-17'),</span></span></span>
<span class="r-in"><span><span class="st">    (2, 'Widget', 19.99, '2024-02-10'),</span></span></span>
<span class="r-in"><span><span class="st">    (3, 'SuperWidget', 49.99, '2024-03-05'),</span></span></span>
<span class="r-in"><span><span class="st">    (4, 'Gadget', 29.99, '2024-04-01'),</span></span></span>
<span class="r-in"><span><span class="st">    (1, 'Thingamajig', 9.99, '2024-04-02');</span></span></span>
<span class="r-in"><span><span class="st">  "</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Ask LLM a question which it will answer using the SQL database:</span></span></span>
<span class="r-in"><span>  <span class="st">"Where are my customers from?"</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">answer_using_sql</span><span class="op">(</span></span></span>
<span class="r-in"><span>      conn <span class="op">=</span> <span class="va">conn</span>,</span></span>
<span class="r-in"><span>      evaluate_code <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>      output_as_tool <span class="op">=</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span>    <span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="send_prompt.html">send_prompt</a></span><span class="op">(</span><span class="fu"><a href="llm_provider_openai.html">llm_provider_openai</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co"># --- Sending request to LLM provider (gpt-4o-mini): ---</span></span></span>
<span class="r-in"><span>  <span class="co"># Where are my customers from?</span></span></span>
<span class="r-in"><span>  <span class="co">#</span></span></span>
<span class="r-in"><span>  <span class="co"># You must code in SQL to answer this prompt. You must provide all SQL code</span></span></span>
<span class="r-in"><span>  <span class="co"># between ```sql and ```.</span></span></span>
<span class="r-in"><span>  <span class="co">#</span></span></span>
<span class="r-in"><span>  <span class="co"># Never make assumptions about the possible values in the tables.</span></span></span>
<span class="r-in"><span>  <span class="co"># Instead, execute SQL queries to retrieve information you need.</span></span></span>
<span class="r-in"><span>  <span class="co">#</span></span></span>
<span class="r-in"><span>  <span class="co"># These tables are available in the database:</span></span></span>
<span class="r-in"><span>  <span class="co">#   customers, orders</span></span></span>
<span class="r-in"><span>  <span class="co">#</span></span></span>
<span class="r-in"><span>  <span class="co"># Table descriptions:</span></span></span>
<span class="r-in"><span>  <span class="co">#   - customers</span></span></span>
<span class="r-in"><span>  <span class="co"># Columns: id, name, email, country</span></span></span>
<span class="r-in"><span>  <span class="co">#</span></span></span>
<span class="r-in"><span>  <span class="co"># - orders</span></span></span>
<span class="r-in"><span>  <span class="co"># Columns: order_id, customer_id, product, amount, order_date</span></span></span>
<span class="r-in"><span>  <span class="co">#</span></span></span>
<span class="r-in"><span>  <span class="co"># Your SQL query will be executed on the database. The results will be sent back</span></span></span>
<span class="r-in"><span>  <span class="co"># to you. After seeing the results, you can either provide a final answer or try</span></span></span>
<span class="r-in"><span>  <span class="co"># another SQL query. When you provide your final answer, do not include any SQL code.</span></span></span>
<span class="r-in"><span>  <span class="co"># --- Receiving response from LLM provider: ---</span></span></span>
<span class="r-in"><span>  <span class="co"># ```sql</span></span></span>
<span class="r-in"><span>  <span class="co"># SELECT DISTINCT country FROM customers;</span></span></span>
<span class="r-in"><span>  <span class="co"># ```</span></span></span>
<span class="r-in"><span>  <span class="co"># --- Sending request to LLM provider (gpt-4o-mini): ---</span></span></span>
<span class="r-in"><span>  <span class="co"># --- SQL code: ---</span></span></span>
<span class="r-in"><span>  <span class="co"># SELECT DISTINCT country FROM customers;</span></span></span>
<span class="r-in"><span>  <span class="co">#</span></span></span>
<span class="r-in"><span>  <span class="co"># --- Query results: ---</span></span></span>
<span class="r-in"><span>  <span class="co">#   country</span></span></span>
<span class="r-in"><span>  <span class="co"># 1     USA</span></span></span>
<span class="r-in"><span>  <span class="co"># 2  Canada</span></span></span>
<span class="r-in"><span>  <span class="co"># 3      UK</span></span></span>
<span class="r-in"><span>  <span class="co"># --- Receiving response from LLM provider: ---</span></span></span>
<span class="r-in"><span>  <span class="co"># Based on the query results, your customers are from the following countries:</span></span></span>
<span class="r-in"><span>  <span class="co"># USA, Canada, and UK.</span></span></span>
<span class="r-in"><span>  <span class="co"># [1] "Based on the query results, your customers are from the following countries:</span></span></span>
<span class="r-in"><span>  <span class="co"># USA, Canada, and UK."</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Luka Koning, Tjark Van de Merwe, Kennispunt Twente.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

