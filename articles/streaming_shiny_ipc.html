<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Streaming LLM responses to Shiny apps • tidyprompt</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Streaming LLM responses to Shiny apps">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidyprompt</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/creating_prompt_wraps.html">Creating prompt wraps</a></li>
    <li><a class="dropdown-item" href="../articles/getting_started.html">Getting started</a></li>
    <li><a class="dropdown-item" href="../articles/sentiment_analysis.html">Sentiment analysis in R with a LLM and 'tidyprompt'</a></li>
    <li><a class="dropdown-item" href="../articles/streaming_shiny_ipc.html">Streaming LLM responses to Shiny apps</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/KennispuntTwente/tidyprompt/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Streaming LLM responses to Shiny apps</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/KennispuntTwente/tidyprompt/blob/main/vignettes/streaming_shiny_ipc.Rmd" class="external-link"><code>vignettes/streaming_shiny_ipc.Rmd</code></a></small>
      <div class="d-none name"><code>streaming_shiny_ipc.Rmd</code></div>
    </div>

    
    
<p>This vignette shows a minimal example of how to stream a LLM response
gathered with ‘tidyprompt’ to a Shiny app in real-time.</p>
<p>Shiny apps run on a single R process, meaning that when you call an
LLM synchronously, the UI will be blocked until the response is
complete. Therefore, when integrating LLM calls into Shiny apps, you
typically want to use <code><a href="../reference/send_prompt.html">send_prompt()</a></code> asynchronously (e.g.,
with the ‘future’ and ‘promises’ packages).</p>
<p>If you just want to show the final LLM response after it is complete,
this is fairly straightforward. But if you want to show the LLM response
as it streams in token-by-token, this is a bit more complex. The
asynchronous process will have to somehow communicate back to the main
Shiny R process to update the UI in real-time as new tokens arrive.</p>
<p>Therefore, for LLM providers created with ‘tidyprompt’ that support
streaming responses, you can set the <code>stream_callback</code> field
of your <code>llm_provider</code> object. This is a function that is
called for each token (or text chunk) as it arrives from the LLM. You
can then leverage this to push the tokens into the Shiny app in
real-time. The ‘ipc’ package can facilitate herein, allowing
inter-process communication between the background R process (where the
LLM call runs) and the main Shiny R process (where the UI runs). Each
time a new output token arrives, the <code>stream_callback</code> can
push then push the token into a reactive value in the main Shiny
process.</p>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>Below is a minimal example which shows how to achieve this. We
will:</p>
<ul>
<li>create an <code>llm_provider</code> with streaming enabled;</li>
<li>define a <code>stream_callback</code> that writes tokens into an
<code>ipc::shinyQueue</code>;</li>
<li>start a <code>future</code> in a separate R process
(<code>future::plan(multisession)</code>) where we call
<code><a href="../reference/send_prompt.html">send_prompt()</a></code>;</li>
<li>consume the queue from the Shiny main process to update the UI,
showing a live stream of LLM output.</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install &amp; load required packages</span></span>
<span><span class="va">packages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"ipc"</span>, <span class="st">"future"</span>, <span class="st">"promises"</span>, <span class="st">"tidyprompt"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">pkg</span> <span class="kw">in</span> <span class="va">packages</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="va">pkg</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="va">pkg</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">pkg</span>, character.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Enable asynchronous processing</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu">plan</span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va">multisession</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Base provider (OpenAI; has streaming enabled by default)</span></span>
<span><span class="va">base_provider</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/llm_provider_openai.html">llm_provider_openai</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">fluidPage</span><span class="op">(</span></span>
<span>  <span class="fu">titlePanel</span><span class="op">(</span><span class="st">"tidyprompt streaming demo"</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="fu">sidebarLayout</span><span class="op">(</span></span>
<span>    <span class="fu">sidebarPanel</span><span class="op">(</span></span>
<span>      <span class="fu">textInput</span><span class="op">(</span></span>
<span>        <span class="st">"prompt"</span>,</span>
<span>        <span class="st">"Prompt"</span>,</span>
<span>        value <span class="op">=</span> <span class="st">"Tell me a short story about a cat and a robot."</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu">actionButton</span><span class="op">(</span><span class="st">"run"</span>, <span class="st">"Ask model"</span><span class="op">)</span>,</span>
<span>      <span class="fu">helpText</span><span class="op">(</span><span class="st">"Tokens will appear below as they stream in."</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span></span>
<span>    <span class="fu">mainPanel</span><span class="op">(</span></span>
<span>      <span class="fu">verbatimTextOutput</span><span class="op">(</span><span class="st">"partial_response"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Queue to bridge async future back into Shiny</span></span>
<span>  <span class="va">queue</span> <span class="op">&lt;-</span> <span class="fu">shinyQueue</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">queue</span><span class="op">$</span><span class="va">consumer</span><span class="op">$</span><span class="fu">start</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="co"># process queue every 100 ms</span></span>
<span></span>
<span>  <span class="co"># Reactive that holds the accumulated streamed text</span></span>
<span>  <span class="va">partial_response</span> <span class="op">&lt;-</span> <span class="fu">reactiveVal</span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Streaming callback run inside the provider</span></span>
<span>  <span class="va">stream_cb</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">token</span>, <span class="va">meta</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># meta$partial_response is the accumulated text so far</span></span>
<span>    <span class="va">queue</span><span class="op">$</span><span class="va">producer</span><span class="op">$</span><span class="fu">fireAssignReactive</span><span class="op">(</span></span>
<span>      <span class="st">"partial_response"</span>,</span>
<span>      <span class="va">meta</span><span class="op">$</span><span class="va">partial_response</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Clone provider for this session and attach callback + streaming</span></span>
<span>  <span class="va">provider</span> <span class="op">&lt;-</span> <span class="va">base_provider</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">provider</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">stream</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>  <span class="va">provider</span><span class="op">$</span><span class="va">stream_callback</span> <span class="op">&lt;-</span> <span class="va">stream_cb</span></span>
<span></span>
<span>  <span class="co"># Expose the reactive value to the UI</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">partial_response</span> <span class="op">&lt;-</span> <span class="fu">renderText</span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">req</span><span class="op">(</span><span class="fu">partial_response</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">partial_response</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">observeEvent</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">run</span>, <span class="op">{</span></span>
<span>    <span class="co"># Reset current streamed text on each run</span></span>
<span>    <span class="fu">partial_response</span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">user_prompt</span> <span class="op">&lt;-</span> <span class="va">input</span><span class="op">$</span><span class="va">prompt</span></span>
<span></span>
<span>    <span class="fu">future_promise</span><span class="op">(</span></span>
<span>      <span class="op">{</span></span>
<span>        <span class="fu">tidyprompt</span><span class="fu">::</span><span class="fu"><a href="../reference/send_prompt.html">send_prompt</a></span><span class="op">(</span></span>
<span>          prompt <span class="op">=</span> <span class="va">user_prompt</span>,</span>
<span>          llm_provider <span class="op">=</span> <span class="va">provider</span>,</span>
<span>          return_mode <span class="op">=</span> <span class="st">"only_response"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span>,</span>
<span>      globals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        user_prompt <span class="op">=</span> <span class="va">user_prompt</span>,</span>
<span>        provider <span class="op">=</span> <span class="va">provider</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">then</span><span class="op">(</span></span>
<span>        onFulfilled <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="co"># Final response once streaming finishes</span></span>
<span>          <span class="fu">partial_response</span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span>        <span class="op">}</span>,</span>
<span>        onRejected <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">error</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="fu">showNotification</span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Error:"</span>, <span class="va">error</span><span class="op">$</span><span class="va">message</span><span class="op">)</span>,</span>
<span>            type <span class="op">=</span> <span class="st">"error"</span></span>
<span>          <span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">error</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>    <span class="cn">NULL</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">shinyApp</span><span class="op">(</span>ui <span class="op">=</span> <span class="va">ui</span>, server <span class="op">=</span> <span class="va">server</span><span class="op">)</span></span></code></pre></div>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Luka Koning, Tjark Van de Merwe, Kennispunt Twente.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
